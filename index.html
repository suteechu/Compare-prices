<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOQ Estimator Pro v5.2 (Add/Delete Room)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Prompt', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f8fafc; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-enter-active, .fade-leave-active { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .fade-enter-from, .fade-leave-to { opacity: 0; transform: translateY(10px); }
        
        .list-move,
        .list-enter-active,
        .list-leave-active { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(-20px); }
        .list-leave-active { position: absolute; }

        /* Custom Gradients */
        .bg-gradient-header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-indigo-100 selection:text-indigo-700">

    <div id="app" class="min-h-screen flex flex-col bg-gradient-to-br from-slate-50 to-slate-100">
        
        <!-- Header with Glassmorphism effect -->
        <header class="bg-slate-900/90 backdrop-blur-md text-white p-4 shadow-xl sticky top-0 z-50 border-b border-slate-700/50">
            <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center space-x-4">
                    <div class="bg-gradient-to-tr from-yellow-400 to-yellow-600 p-2.5 rounded-xl text-slate-900 shadow-lg shadow-yellow-500/20 transform hover:scale-105 transition duration-300">
                        <!-- Building Icon -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold leading-none tracking-tight">BOQ Estimator <span class="font-light text-slate-300">Pro</span></h1>
                        <p class="text-xs text-slate-400 mt-0.5 font-light">ระบบประเมินราคางานสถาปัตย์ & สุขภัณฑ์ v5.2</p>
                    </div>
                </div>
                <div class="flex space-x-1 bg-slate-800/50 p-1.5 rounded-xl border border-slate-700/50">
                    <button @click="activeTab = 'editor'" :class="{'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30': activeTab === 'editor', 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50': activeTab !== 'editor'}" class="px-5 py-2 rounded-lg flex items-center space-x-2 transition-all duration-300 font-medium text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        <span>ปรับแต่งห้อง</span>
                    </button>
                    <button @click="activeTab = 'comparison'" :class="{'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30': activeTab === 'comparison', 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50': activeTab !== 'comparison'}" class="px-5 py-2 rounded-lg flex items-center space-x-2 transition-all duration-300 font-medium text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        <span>สรุปราคา</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-7xl mx-auto w-full p-4 md:p-8 space-y-8">
            
            <!-- VIEW: EDITOR -->
            <div v-if="activeTab === 'editor'" class="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-fade-in">
                
                <!-- Left Sidebar: Room List -->
                <div class="lg:col-span-3 space-y-4">
                    <div class="glass-panel rounded-2xl shadow-sm border border-white/50 flex flex-col h-[calc(100vh-160px)] sticky top-28 overflow-hidden">
                        <div class="p-5 border-b border-slate-100/50 bg-slate-50/50 flex justify-between items-center backdrop-blur-sm">
                            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                                รายการห้อง
                            </h3>
                            <!-- ADD ROOM BUTTON -->
                            <button @click="showAddRoomModal = true" class="text-[10px] bg-indigo-600 hover:bg-indigo-700 text-white px-2.5 py-1.5 rounded-md flex items-center shadow-md shadow-indigo-200 transition-all hover:scale-105">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                เพิ่ม
                            </button>
                        </div>
                        
                        <!-- Room List with Delete Button -->
                        <div class="flex-1 overflow-y-auto p-3 space-y-1.5 custom-scrollbar">
                            <transition-group name="list" tag="div">
                                <div v-for="(room, index) in rooms" :key="room.id" class="relative group">
                                    <button @click="selectedRoomId = room.id"
                                        :class="{'bg-indigo-50 border-indigo-500 text-indigo-700 shadow-sm': selectedRoomId === room.id, 'hover:bg-white text-slate-600 border-transparent hover:shadow-sm': selectedRoomId !== room.id}"
                                        class="w-full text-left p-3.5 rounded-xl border-l-[3px] transition-all duration-200 pr-10">
                                        <div>
                                            <div class="font-bold text-sm truncate pr-2">{{ room.id }}</div>
                                            <div class="text-[11px] opacity-70 truncate mt-0.5">{{ room.name }}</div>
                                        </div>
                                        <!-- Dot indicator for Type -->
                                        <div class="absolute right-3 top-3.5 flex items-center opacity-100 transition-opacity duration-200" :class="{'group-hover:opacity-0': rooms.length > 1}">
                                            <span class="text-[10px] font-medium px-2 py-0.5 rounded-full" :class="getTypeBadgeClass(room.type)">{{ room.type }}</span>
                                        </div>
                                    </button>
                                    
                                    <!-- Delete Button (Visible on Hover) -->
                                    <button v-if="rooms.length > 1" @click.stop="confirmDeleteRoom(index)" 
                                        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full opacity-0 group-hover:opacity-100 transition-all duration-200 z-10"
                                        title="ลบห้องนี้">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    </button>
                                </div>
                            </transition-group>
                        </div>
                        
                        <!-- Summary Footer in Sidebar -->
                        <div class="p-5 border-t border-slate-800 bg-slate-900 text-white">
                            <div class="flex justify-between items-end mb-3">
                                <span class="text-xs text-slate-400 font-light">ราคาสุทธิห้องนี้</span>
                                <span class="text-2xl font-bold text-yellow-400 tracking-tight">{{ formatNumber(currentCost.total) }}</span>
                            </div>
                            <div class="w-full bg-slate-700/50 rounded-full h-1.5 mb-3 overflow-hidden">
                                <div class="bg-gradient-to-r from-blue-500 to-indigo-500 h-1.5 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.5)]" :style="{ width: (currentCost.total > 0 ? (currentCost.material / currentCost.total * 100) : 0) + '%' }"></div>
                            </div>
                            <div class="flex justify-between text-[10px] text-slate-400">
                                <span>วัสดุ: <span class="text-slate-200">{{ formatNumber(currentCost.material) }}</span></span>
                                <span>ค่าแรง: <span class="text-slate-200">{{ formatNumber(currentCost.labor) }}</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content: Editor Area -->
                <div class="lg:col-span-9 space-y-8">
                    
                    <!-- Room Cover Image & Info (Editable Image) -->
                    <div class="bg-white rounded-2xl shadow-lg shadow-slate-200/50 border border-white overflow-hidden relative group transform transition-all duration-500 hover:shadow-xl">
                        <!-- Cover Image -->
                        <div class="h-72 w-full bg-slate-200 relative overflow-hidden group/image">
                            <img :src="currentRoom.customImage || currentRoom.image || getRoomImage(currentRoom.type)" class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105">
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 via-slate-900/40 to-transparent"></div>
                            
                            <!-- Upload Button (Visible on Hover) -->
                            <label class="absolute top-4 right-4 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full cursor-pointer opacity-0 group-hover/image:opacity-100 transition-opacity backdrop-blur-sm border border-white/20 shadow-lg z-20" title="เปลี่ยนรูปปก">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                <input type="file" @change="handleImageUpload" class="hidden" accept="image/*">
                            </label>

                            <!-- Room Title on Image -->
                            <div class="absolute bottom-0 left-0 p-8 w-full text-white pointer-events-none">
                                <div class="flex items-center gap-3 mb-2 animate-fade-in">
                                    <span class="px-2.5 py-1 rounded-md text-xs font-bold uppercase tracking-wider bg-yellow-500 text-slate-900 shadow-lg shadow-yellow-500/20">Type {{ currentRoom.type }}</span>
                                    <span class="text-xs font-medium text-slate-300 bg-slate-800/50 px-2 py-1 rounded backdrop-blur-sm border border-white/10">
                                        {{ currentRoom.width }} x {{ currentRoom.length }} x {{ currentRoom.wallHeight }} ม.
                                    </span>
                                </div>
                                <h2 class="text-4xl font-bold text-white shadow-sm tracking-tight mb-2">{{ currentRoom.name }}</h2>
                                <p class="text-sm text-slate-300 line-clamp-1 opacity-90 max-w-2xl font-light">{{ getRoomDescription(currentRoom.type) }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- 1. หมวดสุขภัณฑ์ (Sanitary Ware) - แบบเพิ่มลดได้ -->
                    <div class="glass-panel rounded-2xl shadow-sm border border-slate-200/60 overflow-hidden">
                        <div class="bg-slate-50/80 px-6 py-5 border-b border-slate-100 flex justify-between items-center sticky top-0 z-10 backdrop-blur-sm">
                            <div class="flex items-center">
                                <div class="p-2.5 bg-white border border-slate-200 rounded-xl mr-4 shadow-sm">
                                    <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 text-lg">สุขภัณฑ์หลัก</h3>
                                    <p class="text-xs text-slate-500 font-light">รายการสุขภัณฑ์และอุปกรณ์ในห้องน้ำ</p>
                                </div>
                            </div>
                            <button @click="addSanitaryItem" class="text-xs font-medium bg-white hover:bg-slate-50 text-indigo-600 border border-indigo-200 hover:border-indigo-300 px-4 py-2 rounded-full flex items-center transition-all shadow-sm">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                เพิ่มรายการ
                            </button>
                        </div>
                        
                        <div class="p-6 bg-white/50">
                            <transition-group name="list" tag="div" class="space-y-4">
                                <div v-for="(item, index) in currentSelection.sanitaryItems" :key="item.key" class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col md:flex-row gap-4 items-start md:items-center relative group hover:shadow-md hover:border-indigo-100 transition-all duration-300">
                                    
                                    <!-- Number Badge -->
                                    <div class="absolute -left-2 -top-2 bg-slate-800 text-white text-[10px] font-bold w-6 h-6 flex items-center justify-center rounded-full shadow-lg ring-2 ring-white z-10">{{ index + 1 }}</div>

                                    <!-- Dropdown Grouped -->
                                    <div class="flex-grow w-full md:w-auto relative">
                                        <label class="text-[10px] font-semibold text-slate-400 uppercase tracking-wider block mb-1.5 ml-1">เลือกรายการ</label>
                                        <div class="relative">
                                            <select v-model="item.id" class="w-full pl-4 pr-10 py-3 bg-slate-50/50 border border-slate-200 hover:border-indigo-300 rounded-xl text-sm focus:ring-2 focus:ring-indigo-100 focus:border-indigo-500 outline-none appearance-none cursor-pointer transition-colors text-slate-700 font-medium shadow-sm">
                                                <optgroup label="โถสุขภัณฑ์ (Toilet)">
                                                    <option v-for="opt in productCatalog.sanitary" :value="opt.id">{{ opt.model }}</option>
                                                </optgroup>
                                                <optgroup label="อ่างล้างหน้า (Basin)">
                                                    <option v-for="opt in productCatalog.basin" :value="opt.id">{{ opt.model }}</option>
                                                </optgroup>
                                                <optgroup label="ก๊อกน้ำ (Faucet)">
                                                    <option v-for="opt in productCatalog.faucet" :value="opt.id">{{ opt.model }}</option>
                                                </optgroup>
                                                <optgroup label="ฝักบัว (Shower)">
                                                    <option v-for="opt in productCatalog.shower" :value="opt.id">{{ opt.model }}</option>
                                                </optgroup>
                                                <optgroup label="อ่างอาบน้ำ (Bathtub)">
                                                    <option v-for="opt in productCatalog.bathtub" :value="opt.id">{{ opt.model }}</option>
                                                </optgroup>
                                            </select>
                                            <div class="absolute right-3 top-3.5 pointer-events-none text-slate-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></div>
                                        </div>
                                    </div>

                                    <!-- Quantity -->
                                    <div class="flex items-center space-x-2 pt-6 md:pt-0">
                                        <div class="text-[10px] text-slate-400 block md:hidden">จำนวน:</div>
                                        <input type="number" v-model.number="item.qty" class="w-20 p-3 border border-slate-200 hover:border-indigo-300 rounded-xl text-sm text-center focus:ring-2 focus:ring-indigo-100 outline-none bg-slate-50/50 font-medium transition-colors" min="1">
                                    </div>

                                    <!-- Price Display (Click to Edit) -->
                                    <div class="min-w-[140px] text-right cursor-pointer hover:bg-slate-50 p-2 rounded-lg transition pt-6 md:pt-0 group/price" @click="editItemPrice(item.id)">
                                        <div class="text-sm font-bold text-slate-700 group-hover/price:text-indigo-600 transition-colors">{{ formatNumber(getItemTotal(item.id, item.qty)) }}</div>
                                        <div class="text-[10px] text-slate-400">(@ {{ formatNumber(getPrice(item).price + getPrice(item).labor) }})</div>
                                    </div>

                                    <!-- Delete Button -->
                                    <button @click="removeSanitaryItem(index)" class="text-slate-300 hover:text-red-500 hover:bg-red-50 p-2.5 rounded-full transition absolute top-2 right-2 md:relative md:top-auto md:right-auto md:mt-6 md:p-2" title="ลบรายการ">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                    </button>
                                </div>
                            </transition-group>
                            
                            <div v-if="!currentSelection.sanitaryItems || currentSelection.sanitaryItems.length === 0" class="text-center py-12 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50">
                                <p class="text-slate-400 mb-2">ยังไม่มีรายการสุขภัณฑ์</p>
                                <button @click="addSanitaryItem" class="text-sm font-medium text-indigo-600 hover:text-indigo-700 hover:underline">เพิ่มรายการแรกเลย</button>
                            </div>
                        </div>
                    </div>

                    <!-- 2. หมวดอุปกรณ์เสริม (Accessories) -->
                    <div class="glass-panel rounded-2xl shadow-sm border border-slate-200/60 overflow-hidden">
                        <div class="bg-slate-50/80 px-6 py-5 border-b border-slate-100 flex justify-between items-center sticky top-0 z-10 backdrop-blur-sm">
                            <div class="flex items-center">
                                <div class="p-2.5 bg-white border border-slate-200 rounded-xl mr-4 shadow-sm">
                                    <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 text-lg">อุปกรณ์เสริม</h3>
                                    <p class="text-xs text-slate-500 font-light">Accessories ตกแต่งเพิ่มเติม</p>
                                </div>
                            </div>
                            <button @click="addAccessory" class="text-xs font-medium bg-white hover:bg-slate-50 text-teal-600 border border-teal-200 hover:border-teal-300 px-4 py-2 rounded-full flex items-center transition-all shadow-sm">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                เพิ่มรายการ
                            </button>
                        </div>
                        <div class="p-6 bg-white/50">
                            <transition-group name="list" tag="div" class="space-y-3">
                                <div v-for="(item, index) in currentSelection.accessories" :key="item.key" class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex flex-col md:flex-row gap-3 items-start md:items-center hover:shadow-md transition-all duration-300">
                                    <div class="flex-grow w-full md:w-auto relative">
                                        <select v-model="item.id" class="w-full p-2.5 bg-slate-50/50 border border-slate-200 hover:border-teal-300 rounded-lg text-sm focus:ring-2 focus:ring-teal-100 focus:border-teal-500 outline-none appearance-none cursor-pointer text-slate-700">
                                            <option v-for="opt in productCatalog.accessories" :key="opt.id" :value="opt.id">{{ opt.model }}</option>
                                        </select>
                                        <div class="absolute right-3 top-3 pointer-events-none text-slate-400"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-slate-400">จำนวน:</span>
                                        <input type="number" v-model.number="item.qty" class="w-16 p-2 border border-slate-200 rounded-lg text-sm text-center focus:ring-2 focus:ring-teal-100 outline-none" min="1">
                                    </div>
                                    <div class="min-w-[120px] text-right cursor-pointer hover:text-teal-600 transition" @click="editItemPrice(item.id)">
                                        <div class="text-sm font-bold text-slate-700">{{ formatNumber(getItemTotal(item.id, item.qty)) }}</div>
                                        <div class="text-[10px] text-slate-400">แก้ไขราคา</div>
                                    </div>
                                    <button @click="removeAccessory(index)" class="text-slate-300 hover:text-red-500 p-1.5 hover:bg-red-50 rounded-full transition">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                    </button>
                                </div>
                            </transition-group>
                            <div v-if="!currentSelection.accessories || currentSelection.accessories.length === 0" class="text-center py-6 text-slate-400 text-sm border border-dashed border-slate-200 rounded-lg">
                                ไม่มีอุปกรณ์เสริม
                            </div>
                        </div>
                    </div>

                    <!-- 3. หมวดกระเบื้อง (Tiles) -->
                    <div class="glass-panel rounded-2xl shadow-sm border border-slate-200/60 overflow-hidden">
                        <div class="bg-slate-50/80 px-6 py-5 border-b border-slate-100 flex items-center sticky top-0 z-10 backdrop-blur-sm">
                            <div class="p-2.5 bg-white border border-slate-200 rounded-xl mr-4 shadow-sm">
                                <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-lg">งานกระเบื้อง</h3>
                                <p class="text-xs text-slate-500 font-light">Tiles & Finishing</p>
                            </div>
                        </div>
                        <div class="p-6 bg-white/50 space-y-6">
                            <!-- Floor Tiles -->
                            <div class="p-5 bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow duration-300">
                                <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-50">
                                    <label class="font-bold text-slate-700 text-sm uppercase tracking-wide flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-orange-400 mr-2"></span>
                                        กระเบื้องพื้น (Floor)
                                    </label>
                                    <div class="flex items-center space-x-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                                        <span class="text-xs text-slate-500 font-medium">พื้นที่:</span>
                                        <input type="number" v-model.number="currentSelection.floorArea" class="w-16 bg-transparent text-right font-bold text-sm focus:outline-none text-slate-700 border-b border-transparent focus:border-orange-400 transition-colors">
                                        <span class="text-xs text-slate-400">ตร.ม.</span>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-3">
                                    <div class="relative">
                                        <select v-model="currentSelection.floorTile" class="w-full pl-4 pr-10 py-3 bg-slate-50/50 border border-slate-200 hover:border-orange-300 rounded-xl text-sm focus:ring-2 focus:ring-orange-100 focus:border-orange-500 outline-none appearance-none cursor-pointer transition-colors text-slate-700">
                                            <option v-for="opt in productCatalog.tiles" :value="opt.id">{{ opt.model }}</option>
                                        </select>
                                        <div class="absolute right-3 top-3.5 pointer-events-none text-slate-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></div>
                                    </div>
                                    <div class="flex justify-end text-xs text-slate-500 cursor-pointer hover:text-orange-600 transition-colors bg-slate-50 inline-block self-end px-3 py-1 rounded-full border border-slate-100" @click="editItemPrice(currentSelection.floorTile)">
                                        ราคาประเมิน: <span class="font-semibold">{{ formatNumber(getPrice({id: currentSelection.floorTile}).price) }}</span> บ./ตร.ม.
                                    </div>
                                </div>
                            </div>

                            <!-- Wall Tiles -->
                            <div class="p-5 bg-white rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow duration-300">
                                <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-50">
                                    <label class="font-bold text-slate-700 text-sm uppercase tracking-wide flex items-center">
                                        <span class="w-2 h-2 rounded-full bg-orange-300 mr-2"></span>
                                        กระเบื้องผนัง (Wall)
                                    </label>
                                    <div class="flex items-center space-x-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                                        <span class="text-xs text-slate-500 font-medium">พื้นที่:</span>
                                        <input type="number" v-model.number="currentSelection.wallArea" class="w-16 bg-transparent text-right font-bold text-sm focus:outline-none text-slate-700 border-b border-transparent focus:border-orange-400 transition-colors">
                                        <span class="text-xs text-slate-400">ตร.ม.</span>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-3">
                                    <div class="relative">
                                        <select v-model="currentSelection.wallTile" class="w-full pl-4 pr-10 py-3 bg-slate-50/50 border border-slate-200 hover:border-orange-300 rounded-xl text-sm focus:ring-2 focus:ring-orange-100 focus:border-orange-500 outline-none appearance-none cursor-pointer transition-colors text-slate-700">
                                            <option v-for="opt in productCatalog.tiles" :value="opt.id">{{ opt.model }}</option>
                                        </select>
                                        <div class="absolute right-3 top-3.5 pointer-events-none text-slate-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></div>
                                    </div>
                                    <div class="flex justify-end text-xs text-slate-500 cursor-pointer hover:text-orange-600 transition-colors bg-slate-50 inline-block self-end px-3 py-1 rounded-full border border-slate-100" @click="editItemPrice(currentSelection.wallTile)">
                                        ราคาประเมิน: <span class="font-semibold">{{ formatNumber(getPrice({id: currentSelection.wallTile}).price) }}</span> บ./ตร.ม.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: COMPARISON -->
            <div v-if="activeTab === 'comparison'" class="space-y-8 animate-fade-in pb-16">
                <div class="flex justify-between items-end bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-800 tracking-tight">สรุปงบประมาณ</h2>
                        <p class="text-slate-500 text-sm mt-1">เปรียบเทียบราคาแยกรายห้อง</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-slate-500 font-medium uppercase tracking-wider mb-1">ยอดรวมทั้งโครงการ</div>
                        <div class="text-4xl font-bold text-emerald-600 tracking-tight">{{ formatNumber(totalProjectCost.total) }} <span class="text-lg text-slate-400 font-normal">บาท</span></div>
                    </div>
                </div>

                <!-- CHART SECTION -->
                <div class="glass-panel p-6 rounded-2xl shadow-lg border border-white/50">
                    <div class="relative h-96 w-full">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
                
                <!-- TABLE SECTION -->
                <div class="overflow-hidden bg-white rounded-2xl shadow-lg border border-slate-100">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50/80 border-b border-slate-200 text-slate-500 text-xs font-bold uppercase tracking-wider">
                                <th class="p-5">ห้อง</th>
                                <th class="p-5">Type</th>
                                <th class="p-5 text-right hidden md:table-cell">ค่าวัสดุ</th>
                                <th class="p-5 text-right hidden md:table-cell">ค่าแรง</th>
                                <th class="p-5 text-right text-slate-700">รวมสุทธิ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 text-sm">
                            <tr v-for="room in rooms" :key="room.id" class="hover:bg-indigo-50/30 transition duration-200 group">
                                <td class="p-5 font-semibold text-indigo-600 group-hover:text-indigo-700">{{ room.id }}</td>
                                <td class="p-5">
                                    <span class="px-2.5 py-1 rounded-full text-[10px] font-bold shadow-sm" :class="getTypeBadgeClass(room.type)">{{ room.type }}</span>
                                </td>
                                <td class="p-5 text-right text-slate-600 hidden md:table-cell font-mono">{{ formatNumber(calculateCost(room.id).material) }}</td>
                                <td class="p-5 text-right text-slate-600 hidden md:table-cell font-mono">{{ formatNumber(calculateCost(room.id).labor) }}</td>
                                <td class="p-5 text-right font-bold text-slate-800 font-mono text-base">{{ formatNumber(calculateCost(room.id).total) }}</td>
                            </tr>
                        </tbody>
                        <tfoot class="bg-slate-900 text-white">
                            <tr>
                                <td colspan="2" class="p-5 text-right font-bold uppercase tracking-wide text-sm">รวมทั้งโครงการ</td>
                                <td class="p-5 text-right text-slate-400 hidden md:table-cell font-mono">{{ formatNumber(totalProjectCost.material) }}</td>
                                <td class="p-5 text-right text-slate-400 hidden md:table-cell font-mono">{{ formatNumber(totalProjectCost.labor) }}</td>
                                <td class="p-5 text-right font-bold text-xl text-yellow-400 font-mono">{{ formatNumber(totalProjectCost.total) }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </main>

        <!-- ADD ROOM MODAL (Polished) -->
        <div v-if="showAddRoomModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm animate-fade-in" @click.self="showAddRoomModal = false">
            <div class="bg-white p-8 rounded-3xl shadow-2xl w-96 border border-white/20 transform transition-all scale-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-slate-800">เพิ่มห้องใหม่</h3>
                    <button @click="showAddRoomModal = false" class="text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full p-1 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">รหัสห้อง</label>
                        <input type="text" v-model="newRoomData.id" class="w-full border border-slate-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow" placeholder="เช่น WC-Guest-01">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ชื่อห้อง</label>
                        <input type="text" v-model="newRoomData.name" class="w-full border border-slate-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow" placeholder="เช่น ห้องน้ำแขก">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">กว้าง (ม.)</label>
                            <input type="number" v-model.number="newRoomData.width" class="w-full border border-slate-300 rounded-xl px-4 py-3 text-sm text-center focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ยาว (ม.)</label>
                            <input type="number" v-model.number="newRoomData.length" class="w-full border border-slate-300 rounded-xl px-4 py-3 text-sm text-center focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">ประเภท (Type)</label>
                        <select v-model="newRoomData.type" class="w-full border border-slate-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                            <option value="S">Type S (ห้องน้ำมาตรฐาน)</option>
                            <option value="S1">Type S1 (ห้องน้ำโซนเปียก)</option>
                            <option value="B">Type B (มีอ่างอาบน้ำ)</option>
                            <option value="T">Type T (Powder Room)</option>
                            <option value="U">Type U (ห้องน้ำชาย)</option>
                        </select>
                    </div>
                    <button @click="addNewRoom" class="bg-indigo-600 text-white text-sm font-bold w-full py-3.5 rounded-xl mt-4 hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 active:scale-95 transform duration-200">
                        ยืนยันการสร้างห้อง
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Price Modal (Polished) -->
        <div v-if="editingItemId" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm animate-fade-in" @click.self="editingItemId = null">
            <div class="bg-white p-8 rounded-3xl shadow-2xl w-80 border border-white/20 transform transition-all scale-100">
                <div class="text-center mb-6">
                    <div class="bg-indigo-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800">แก้ไขราคาต่อหน่วย</h3>
                    <p class="text-xs text-slate-400">ระบุราคาใหม่ที่ต้องการ</p>
                </div>
                <div class="space-y-4">
                    <div class="relative">
                        <label class="absolute -top-2 left-3 bg-white px-1 text-[10px] font-bold text-indigo-500 uppercase tracking-wide">ค่าวัสดุ</label>
                        <input type="number" v-model.number="editPriceVal" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 text-right text-slate-700 focus:border-indigo-500 focus:ring-0 outline-none text-xl font-bold font-mono">
                    </div>
                    <div class="relative">
                        <label class="absolute -top-2 left-3 bg-white px-1 text-[10px] font-bold text-orange-500 uppercase tracking-wide">ค่าแรง</label>
                        <input type="number" v-model.number="editLaborVal" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 text-right text-slate-700 focus:border-orange-500 focus:ring-0 outline-none text-xl font-bold font-mono">
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button @click="editingItemId = null" class="flex-1 bg-slate-100 text-slate-500 text-sm font-bold py-3 rounded-xl hover:bg-slate-200 transition">ยกเลิก</button>
                        <button @click="saveCustomPrice" class="flex-1 bg-indigo-600 text-white text-sm font-bold py-3 rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">
                            บันทึก
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, reactive, onMounted, watch, nextTick } = Vue;

        const INITIAL_ROOMS_DATA = [
            { id: '1822S', name: 'WC 1822S (Shower)', type: 'S', width: 1.8, length: 2.2, wallHeight: 2.6, image: 'https://placehold.co/800x400/3b82f6/ffffff.png?text=Room+Type+S+(Shower+Zone)' },
            { id: '1822T', name: 'WC 1822T (Toilet Only)', type: 'T', width: 1.8, length: 2.2, wallHeight: 2.6, image: 'https://placehold.co/800x400/fbbf24/ffffff.png?text=Room+Type+T+(Powder+Room)' },
            { id: '1822U', name: 'WC 1822U (Urinal)', type: 'U', width: 1.8, length: 2.2, wallHeight: 2.6, image: 'https://placehold.co/800x400/64748b/ffffff.png?text=Room+Type+U+(Urinal)' },
            { id: '2236B', name: 'WC 2236-B (Bathtub)', type: 'B', width: 2.2, length: 3.6, wallHeight: 2.8, image: 'https://placehold.co/800x400/a855f7/ffffff.png?text=Room+Type+B+(Bathtub)' },
            { id: '2245B', name: 'WC 2245-B (Master)', type: 'B', width: 2.2, length: 4.5, wallHeight: 2.8, image: 'https://placehold.co/800x400/a855f7/ffffff.png?text=Master+Bath+(Jacuzzi)' },
            { id: '2245S1', name: 'WC 2245-S1 (Shower Type 1)', type: 'S1', width: 2.2, length: 4.5, wallHeight: 2.8, image: 'https://placehold.co/800x400/06b6d4/ffffff.png?text=Room+Type+S1+(Premium+Shower)' },
        ];

        // Central Product Catalog (Same as v4)
        const PRODUCT_CATALOG = {
            sanitary: [
                { id: '1pc-premium', model: 'C10527 (1-Piece Premium)', price: 12500, labor: 800 },
                { id: '1pc-std', model: 'C1141 (1-Piece Standard)', price: 8500, labor: 800 },
                { id: '2pc-std', model: 'C13507 (2-Piece Standard)', price: 4500, labor: 600 },
                { id: 'urinal', model: 'C31217 (Urinal + Sensor)', price: 5500, labor: 500 },
            ],
            basin: [
                { id: 'counter-l', model: 'C017 (Full Counter)', price: 3800, labor: 500 },
                { id: 'wall', model: 'SC00537 (Wall Hung)', price: 1200, labor: 400 },
                { id: 'cabinet', model: 'C014+VCM101 (Cabinet)', price: 8500, labor: 800 },
            ],
            faucet: [
                { id: 'f-prem', model: 'CT144AY (Tall Faucet)', price: 2800, labor: 150 },
                { id: 'f-std', model: 'CT1058A (Standard)', price: 1200, labor: 150 },
            ],
            shower: [
                { id: 's-rain', model: 'Rain Shower Set', price: 8900, labor: 300 },
                { id: 's-std', model: 'Hand Shower Z71', price: 1500, labor: 200 },
            ],
            bathtub: [
                { id: 'b-jacuzzi', model: 'Jacuzzi BWA428PP', price: 45000, labor: 3500 },
                { id: 'b-std', model: 'Standard Tub BH243PP', price: 12000, labor: 2500 },
            ],
            tiles: [
                { id: 't-marble', model: 'ลายหินอ่อน (Marble 60x60)', price: 650, labor: 350 },
                { id: 't-ceramic', model: 'เซรามิก (Ceramic 30x30)', price: 250, labor: 300 },
                { id: 't-granito', model: 'แกรนิตโต้ (Granito 60x60)', price: 450, labor: 320 },
            ],
            accessories: [
                { id: 'acc-mirror', model: 'กระจกเงา (Mirror 60x80)', price: 1200, labor: 200 },
                { id: 'acc-spray', model: 'สายฉีดชำระ (Rinsing Spray)', price: 450, labor: 100 },
                { id: 'acc-safety', model: 'ราวจับกันลื่น (Safety Bar)', price: 1500, labor: 300 },
                { id: 'acc-shelf', model: 'ชั้นวางของ (Glass Shelf)', price: 850, labor: 150 },
            ]
        };

        const app = createApp({
            setup() {
                const activeTab = ref('editor');
                // Make rooms reactive so we can add to it
                const rooms = ref(INITIAL_ROOMS_DATA);
                const selectedRoomId = ref(rooms.value[0].id);
                
                const productCatalog = PRODUCT_CATALOG;
                const roomSelections = reactive({});
                const customPrices = reactive({});
                
                // Add Room State
                const showAddRoomModal = ref(false);
                const newRoomData = reactive({
                    id: '',
                    name: '',
                    width: 2.0,
                    length: 2.0,
                    type: 'S'
                });
                
                // Editing State
                const editingItemId = ref(null);
                const editPriceVal = ref(0);
                const editLaborVal = ref(0);

                let chartInstance = null;

                // --- Helper: Get Default Sanitary Items based on Room Type ---
                const getDefaultSanitaryItems = (type) => {
                    const items = [];
                    // Common items
                    if (type !== 'U') items.push({ id: '1pc-std', qty: 1, key: Date.now() }); // Toilet
                    items.push({ id: 'wall', qty: 1, key: Date.now()+1 }); // Basin
                    items.push({ id: 'f-std', qty: 1, key: Date.now()+2 }); // Faucet
                    
                    // Specifics
                    if (type === 'S' || type === 'S1') items.push({ id: 's-std', qty: 1, key: Date.now()+3 });
                    if (type === 'B') {
                        // Upgrade for B type
                        items[0].id = '1pc-premium';
                        items.push({ id: 'b-std', qty: 1, key: Date.now()+4 });
                    }
                    if (type === 'U') items.push({ id: 'urinal', qty: 2, key: Date.now()+5 });
                    
                    return items;
                };
                
                const getRoomImage = (type) => {
                    if (type === 'B') return 'https://placehold.co/800x400/a855f7/ffffff.png?text=Room+Type+B';
                    if (type === 'S' || type === 'S1') return 'https://placehold.co/800x400/3b82f6/ffffff.png?text=Room+Type+S';
                    if (type === 'U') return 'https://placehold.co/800x400/64748b/ffffff.png?text=Room+Type+U';
                    return 'https://placehold.co/800x400/fbbf24/ffffff.png?text=Room+Type';
                };

                // Initialize Data for initial rooms
                rooms.value.forEach(room => {
                    roomSelections[room.id] = {
                        sanitaryItems: getDefaultSanitaryItems(room.type),
                        accessories: [
                            { id: 'acc-spray', qty: 1, key: Date.now()+10 }, 
                            { id: 'acc-mirror', qty: 1, key: Date.now()+11 }
                        ],
                        wallTile: 't-ceramic',
                        floorTile: 't-ceramic',
                        floorArea: parseFloat((room.width * room.length).toFixed(2)),
                        wallArea: parseFloat(((room.width + room.length) * 2 * room.wallHeight).toFixed(2))
                    };
                });

                const currentRoom = computed(() => rooms.value.find(r => r.id === selectedRoomId.value) || rooms.value[0]);
                const currentSelection = computed(() => roomSelections[selectedRoomId.value] || {});

                const getRoomDescription = (type) => {
                    if (type === 'B') return "ห้องน้ำ Master พร้อมอ่างอาบน้ำและพื้นที่กว้างขวาง";
                    if (type === 'S' || type === 'S1') return "ห้องน้ำมาตรฐาน แยกโซนเปียกแห้งด้วยฝักบัว";
                    if (type === 'U') return "ห้องน้ำชาย เน้นโถปัสสาวะและการใช้งานที่คล่องตัว";
                    if (type === 'T') return "ห้อง Powder Room สำหรับรับแขก ไม่มีโซนอาบน้ำ";
                    return "";
                };

                const getTypeBadgeClass = (type) => {
                    if (type === 'B') return 'bg-purple-100 text-purple-700 ring-1 ring-purple-600/20';
                    if (type === 'S' || type === 'S1') return 'bg-blue-100 text-blue-700 ring-1 ring-blue-600/20';
                    if (type === 'U') return 'bg-slate-200 text-slate-700 ring-1 ring-slate-600/20';
                    return 'bg-yellow-100 text-yellow-700 ring-1 ring-yellow-600/20';
                };

                // --- Pricing Logic ---
                const findProduct = (id) => {
                    for (const cat in productCatalog) {
                        const found = productCatalog[cat].find(i => i.id === id);
                        if (found) return found;
                    }
                    return { price: 0, labor: 0 };
                };

                const getPrice = (itemOrId) => {
                    const id = typeof itemOrId === 'string' ? itemOrId : itemOrId.id;
                    const defaultItem = findProduct(id);
                    const custom = customPrices[id];
                    return {
                        price: custom?.price !== undefined ? custom.price : defaultItem.price,
                        labor: custom?.labor !== undefined ? custom.labor : defaultItem.labor,
                    };
                };

                const getItemTotal = (id, qty) => {
                    const p = getPrice(id);
                    return (p.price + p.labor) * qty;
                };

                // --- Edit Price Modal Logic ---
                const editItemPrice = (id) => {
                    const p = getPrice(id);
                    editPriceVal.value = p.price;
                    editLaborVal.value = p.labor;
                    editingItemId.value = id;
                };

                const saveCustomPrice = () => {
                    if (editingItemId.value) {
                        if (!customPrices[editingItemId.value]) customPrices[editingItemId.value] = {};
                        customPrices[editingItemId.value].price = editPriceVal.value;
                        customPrices[editingItemId.value].labor = editLaborVal.value;
                        editingItemId.value = null;
                    }
                };

                // --- List Management ---
                const addSanitaryItem = () => {
                    if (!roomSelections[selectedRoomId.value].sanitaryItems) roomSelections[selectedRoomId.value].sanitaryItems = [];
                    roomSelections[selectedRoomId.value].sanitaryItems.push({ id: '1pc-std', qty: 1, key: Date.now() });
                };
                const removeSanitaryItem = (index) => {
                    roomSelections[selectedRoomId.value].sanitaryItems.splice(index, 1);
                };

                const addAccessory = () => {
                    if (!roomSelections[selectedRoomId.value].accessories) roomSelections[selectedRoomId.value].accessories = [];
                    roomSelections[selectedRoomId.value].accessories.push({ id: 'acc-shelf', qty: 1, key: Date.now() });
                };
                const removeAccessory = (index) => {
                    roomSelections[selectedRoomId.value].accessories.splice(index, 1);
                };
                
                // --- Add Room Logic ---
                const addNewRoom = () => {
                    if (!newRoomData.id || !newRoomData.name) {
                        alert("กรุณากรอกรหัสห้องและชื่อห้อง");
                        return;
                    }
                    
                    const newRoom = {
                        id: newRoomData.id,
                        name: newRoomData.name,
                        width: newRoomData.width,
                        length: newRoomData.length,
                        wallHeight: 2.6, // Default
                        type: newRoomData.type,
                        image: getRoomImage(newRoomData.type)
                    };
                    
                    // Init selections for new room
                    roomSelections[newRoom.id] = {
                        sanitaryItems: getDefaultSanitaryItems(newRoom.type),
                        accessories: [
                            { id: 'acc-spray', qty: 1, key: Date.now() }
                        ],
                        wallTile: 't-ceramic',
                        floorTile: 't-ceramic',
                        floorArea: parseFloat((newRoom.width * newRoom.length).toFixed(2)),
                        wallArea: parseFloat(((newRoom.width + newRoom.length) * 2 * 2.6).toFixed(2))
                    };
                    
                    rooms.value.push(newRoom);
                    selectedRoomId.value = newRoom.id;
                    showAddRoomModal.value = false;
                    
                    // Reset form
                    newRoomData.id = '';
                    newRoomData.name = '';
                };

                // --- Delete Room Logic ---
                const confirmDeleteRoom = (index) => {
                    if (confirm("คุณแน่ใจหรือไม่ว่าต้องการลบห้องนี้?")) {
                        const deletedRoomId = rooms.value[index].id;
                        rooms.value.splice(index, 1);
                        
                        // Clean up selections
                        delete roomSelections[deletedRoomId];
                        
                        // Reset selection if current room was deleted
                        if (selectedRoomId.value === deletedRoomId && rooms.value.length > 0) {
                            selectedRoomId.value = rooms.value[0].id;
                        }
                    }
                };

                // --- Calculation ---
                const calculateCost = (roomId) => {
                    const sel = roomSelections[roomId];
                    if (!sel) return { material: 0, labor: 0, total: 0 };

                    let totalM = 0, totalL = 0;

                    // Sanitary Items
                    if (sel.sanitaryItems) {
                        sel.sanitaryItems.forEach(item => {
                            const p = getPrice(item.id);
                            totalM += p.price * item.qty;
                            totalL += p.labor * item.qty;
                        });
                    }

                    // Accessories
                    if (sel.accessories) {
                        sel.accessories.forEach(item => {
                            const p = getPrice(item.id);
                            totalM += p.price * item.qty;
                            totalL += p.labor * item.qty;
                        });
                    }

                    // Tiles
                    const wP = getPrice(sel.wallTile);
                    const fP = getPrice(sel.floorTile);
                    totalM += (sel.wallArea * wP.price) + (sel.floorArea * fP.price);
                    totalL += (sel.wallArea * wP.labor) + (sel.floorArea * fP.labor);

                    return { material: totalM, labor: totalL, total: totalM + totalL };
                };

                const currentCost = computed(() => calculateCost(selectedRoomId.value));
                
                const totalProjectCost = computed(() => {
                    let totalM = 0, totalL = 0;
                    rooms.value.forEach(r => {
                        const c = calculateCost(r.id);
                        totalM += c.material;
                        totalL += c.labor;
                    });
                    return { material: totalM, labor: totalL, total: totalM + totalL };
                });

                const formatNumber = (num) => num ? num.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) : '0';

                // --- Chart ---
                const renderChart = async () => {
                    await nextTick();
                    const ctx = document.getElementById('comparisonChart');
                    if (!ctx) return;

                    const labels = rooms.value.map(r => r.id);
                    const matData = rooms.value.map(r => calculateCost(r.id).material);
                    const labData = rooms.value.map(r => calculateCost(r.id).labor);

                    if (chartInstance) chartInstance.destroy();

                    chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'ค่าวัสดุ', data: matData, backgroundColor: 'rgba(99, 102, 241, 0.8)', borderRadius: 6, hoverBackgroundColor: 'rgba(99, 102, 241, 1)' },
                                { label: 'ค่าแรง', data: labData, backgroundColor: 'rgba(251, 191, 36, 0.8)', borderRadius: 6, hoverBackgroundColor: 'rgba(251, 191, 36, 1)' }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { 
                                x: { stacked: true, grid: { display: false } }, 
                                y: { stacked: true, border: { dash: [4, 4] }, grid: { color: '#f1f5f9' } } 
                            },
                            plugins: {
                                legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                            }
                        }
                    });
                };

                watch(activeTab, (newTab) => { if (newTab === 'comparison') renderChart(); });

                // --- Image Upload Logic (Fix) ---
                const handleImageUpload = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            // Find the current room in the reactive rooms array
                            const roomIndex = rooms.value.findIndex(r => r.id === selectedRoomId.value);
                            if (roomIndex !== -1) {
                                // Update customImage property
                                rooms.value[roomIndex].customImage = e.target.result;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                };

                return {
                    activeTab, selectedRoomId, rooms, productCatalog, currentSelection, currentRoom,
                    currentCost, totalProjectCost, getTypeBadgeClass, getRoomDescription, getRoomImage,
                    addSanitaryItem, removeSanitaryItem, addAccessory, removeAccessory,
                    editItemPrice, saveCustomPrice, editingItemId, editPriceVal, editLaborVal,
                    formatNumber, getItemTotal, getPrice, calculateCost,
                    showAddRoomModal, newRoomData, addNewRoom, handleImageUpload, confirmDeleteRoom
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
