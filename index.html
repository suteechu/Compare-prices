<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Cost Estimator Pro V9</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body, .font-sans, .font-mono { font-family: 'IBM Plex Sans Thai', sans-serif !important; }
        body { background-color: #f8fafc; } /* Slate-50 for cleaner look */
        .hide-print { display: block; }
        @media print {
            .hide-print { display: none !important; }
            .page-break { page-break-inside: avoid; }
            body { background-color: white; }
            .fixed-footer { position: relative !important; margin-top: 2rem; border-top: 2px solid #333 !important; }
        }
        .generating-pdf .hide-print { display: none !important; }
        .generating-pdf .fixed-footer { position: relative !important; margin-top: 20px; background: white !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .slide-up { animation: slideUp 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Custom Slider Style */
        .range-slider { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 5px; background: #e2e8f0; outline: none; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #10b981; cursor: pointer; transition: background .15s ease-in-out; }
        .range-slider::-webkit-slider-thumb:hover { background: #059669; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Configuration
        const INITIAL_CATEGORIES_DEFAULT = [
            { id: 'cat_01', name: '1. ค่าจ้างทีมงาน (HR/Personnel)', icon: 'ph-users', color: 'bg-blue-100 text-blue-700' },
            { id: 'cat_02', name: '2. ค่าพัฒนา/ผลิต (Dev/Production)', icon: 'ph-code', color: 'bg-indigo-100 text-indigo-700' },
            { id: 'cat_03', name: '3. การตลาด (Marketing/Ads)', icon: 'ph-megaphone', color: 'bg-orange-100 text-orange-700' },
            { id: 'cat_04', name: '4. โครงสร้างพื้นฐาน (Server/Cloud)', icon: 'ph-cloud', color: 'bg-sky-100 text-sky-700' },
            { id: 'cat_05', name: '5. ซอฟต์แวร์/ไลเซนส์ (Tools)', icon: 'ph-desktop', color: 'bg-cyan-100 text-cyan-700' },
            { id: 'cat_06', name: '6. จ้างภายนอก (Outsource)', icon: 'ph-handshake', color: 'bg-emerald-100 text-emerald-700' },
            { id: 'cat_07', name: '7. ค่าบริหารจัดการ (Admin/Ops)', icon: 'ph-files', color: 'bg-slate-200 text-slate-700' },
            { id: 'cat_08', name: '8. กฎหมาย/บัญชี (Legal/Acct)', icon: 'ph-scales', color: 'bg-yellow-100 text-yellow-700' },
            { id: 'cat_09', name: '9. การเดินทาง/ที่พัก (Travel)', icon: 'ph-airplane', color: 'bg-purple-100 text-purple-700' },
            { id: 'cat_10', name: '10. สำรองฉุกเฉิน (Contingency)', icon: 'ph-shield-check', color: 'bg-rose-100 text-rose-700' },
        ];

        const formatMoney = (amount) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 }).format(amount);
        const formatNumber = (num) => new Intl.NumberFormat('th-TH', { maximumFractionDigits: 2 }).format(num);

        const Toast = ({ message, onClose }) => {
            useEffect(() => { const timer = setTimeout(onClose, 2000); return () => clearTimeout(timer); }, [onClose]);
            return (
                <div className="fixed top-4 right-4 z-[999] bg-gray-900 text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3 slide-up border border-gray-700">
                    <i className="ph-fill ph-check-circle text-emerald-400 text-xl"></i>
                    <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };
        
        const ThaiBahtText = (num) => {
            num = num || 0;
            const t = ["", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า", "หก", "เจ็ด", "แปด", "เก้า"];
            const u = ["", "สิบ", "ร้อย", "พัน", "หมื่น", "แสน", "ล้าน"];
            let s = num.toString().split(".");
            let n = s[0];
            let k = "";
            if (n.length > 7) return "จำนวนเงินสูงเกินไป"; 
            for (let i = 0; i < n.length; i++) {
                let d = parseInt(n.charAt(i));
                if (d != 0) {
                    if (i == n.length - 1 && d == 1 && n.length > 1) k += "เอ็ด";
                    else if (i == n.length - 2 && d == 2) k += "ยี่";
                    else if (i == n.length - 2 && d == 1) k += "";
                    else k += t[d];
                    k += u[n.length - i - 1];
                }
            }
            return k ? k + "บาทถ้วน" : "ศูนย์บาทถ้วน";
        }

        // --- Charts ---
        const DonutChart = ({ data, total }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            useEffect(() => {
                if (total <= 0) return;
                const ctx = chartRef.current.getContext('2d');
                if (chartInstance.current) chartInstance.current.destroy();
                chartInstance.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(d => d.name),
                        datasets: [{
                            data: data.map(d => d.value),
                            backgroundColor: ['#3b82f6', '#6366f1', '#f97316', '#0ea5e9', '#06b6d4', '#10b981', '#64748b', '#eab308', '#a855f7', '#f43f5e'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => ` ${ctx.label}: ${formatMoney(ctx.raw)}` }, bodyFont: { family: "'IBM Plex Sans Thai', sans-serif" } } },
                        cutout: '75%'
                    }
                });
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data, total]);
            if (total <= 0) return null;
            return (
                <div className="relative h-40 w-40 mx-auto">
                    <canvas ref={chartRef}></canvas>
                    <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span className="text-[10px] text-gray-400 font-bold uppercase tracking-wide">Total Budget</span>
                        <span className="text-xs font-bold text-gray-800">{formatNumber(total/1000000)}M</span>
                    </div>
                </div>
            );
        };

        const ComparisonBarChart = ({ scenarios, scenarioIds, scenarioMeta, categories }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            useEffect(() => {
                if (scenarioIds.length < 2) return;
                const ctx = chartRef.current.getContext('2d');
                const id1 = scenarioIds[0];
                const id2 = scenarioIds[1];
                const data1 = categories.map(cat => (scenarios[id1]?.[cat.id]?.[0]?.total || 0));
                const data2 = categories.map(cat => (scenarios[id2]?.[cat.id]?.[0]?.total || 0));

                if (chartInstance.current) chartInstance.current.destroy();
                chartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: categories.map(c => c.name.split('. ')[1] || c.name),
                        datasets: [
                            { label: scenarioMeta[id1]?.name, data: data1, backgroundColor: 'rgba(59, 130, 246, 0.7)', borderRadius: 4 },
                            { label: scenarioMeta[id2]?.name, data: data2, backgroundColor: 'rgba(16, 185, 129, 0.7)', borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: { 
                            x: { ticks: { font: { family: "'IBM Plex Sans Thai', sans-serif", size: 10 } }, grid: { display: false } }, 
                            y: { grid: { borderDash: [5, 5] }, ticks: { font: { family: "'IBM Plex Sans Thai', sans-serif", size: 10 } } } 
                        },
                        plugins: { tooltip: { bodyFont: { family: "'IBM Plex Sans Thai', sans-serif" } }, legend: { labels: { font: { family: "'IBM Plex Sans Thai', sans-serif" } } } }
                    }
                });
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [scenarios, scenarioIds, scenarioMeta, categories]);
            return <div className="h-[350px] w-full p-2"><canvas ref={chartRef}></canvas></div>;
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState(1);
            const [editingTab, setEditingTab] = useState(null);
            const [editNameValue, setEditNameValue] = useState("");
            const [toastMessage, setToastMessage] = useState(null);
            const [projectName, setProjectName] = useState("โครงการพัฒนา Application A");
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [isExporting, setIsExporting] = useState(false);
            const [riskFactor, setRiskFactor] = useState(0);

            // Categories
            const [categories, setCategories] = useState(() => {
                const saved = localStorage.getItem('projCostCatsV1');
                return saved ? JSON.parse(saved) : INITIAL_CATEGORIES_DEFAULT;
            });

            // Data
            const [scenarios, setScenarios] = useState(() => {
                const saved = localStorage.getItem('projCostDataV1');
                const def = { 1: {}, 2: {} };
                INITIAL_CATEGORIES_DEFAULT.forEach(c => { def[1][c.id] = []; def[2][c.id] = []; });
                return saved ? JSON.parse(saved) : def;
            });

            // Meta
            const [scenarioMeta, setScenarioMeta] = useState(() => {
                const saved = localStorage.getItem('projCostMetaV1');
                return saved ? JSON.parse(saved) : { 
                    1: { duration: 6, name: 'Option 1: ทำเอง (In-house)', markup: 0 }, 
                    2: { duration: 4, name: 'Option 2: จ้างทำ (Outsource)', markup: 0 } 
                };
            });
            
            const [bulkItems, setBulkItems] = useState([]);
            
            const scrollRef = useRef(null);
            const coverInputRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('projCostDataV1', JSON.stringify(scenarios));
                localStorage.setItem('projCostMetaV1', JSON.stringify(scenarioMeta));
                localStorage.setItem('projCostCatsV1', JSON.stringify(categories));
            }, [scenarios, scenarioMeta, categories]);

            // Sync UI
            useEffect(() => {
                if (activeTab === 'compare') return;
                const currentData = scenarios[activeTab] || {};
                const loadedItems = categories.map(cat => {
                    const existing = currentData[cat.id]?.[0];
                    return { categoryId: cat.id, total: existing ? existing.total.toString() : "" };
                });
                setBulkItems(loadedItems);
            }, [activeTab, categories, scenarios]);

            const scenarioIds = useMemo(() => Object.keys(scenarios).map(Number).sort((a, b) => a - b), [scenarios]);

            const handleBulkChange = (index, value) => {
                const newItems = [...bulkItems];
                newItems[index] = { ...newItems[index], total: value };
                setBulkItems(newItems);
            };

            const resetRow = (index) => {
                const newItems = [...bulkItems];
                newItems[index] = { ...newItems[index], total: "" };
                setBulkItems(newItems);
            };

            const handleMetaChange = (id, field, value) => {
                setScenarioMeta(prev => ({
                    ...prev,
                    [id]: { ...prev[id], [field]: (field === 'duration' || field === 'markup') ? (parseFloat(value) || 0) : value }
                }));
            };
            
            const handleCategoryNameChange = (catId, newName) => {
                setCategories(categories.map(c => c.id === catId ? { ...c, name: newName } : c));
            };

            const handleAddCategory = () => {
                const newId = `cat_${Date.now()}`;
                const newCat = { id: newId, name: 'หมวดหมู่ใหม่', icon: 'ph-circles-four', color: 'bg-gray-100 text-gray-700' };
                setCategories([...categories, newCat]);
                setToastMessage("เพิ่มหมวดหมู่ใหม่แล้ว");
            };

            const handleDeleteCategory = (catId) => {
                if (categories.length <= 1) return alert("ต้องมีอย่างน้อย 1 หมวดหมู่");
                if (!confirm("ต้องการลบหมวดหมู่นี้?")) return;
                setCategories(categories.filter(c => c.id !== catId));
                setToastMessage("ลบหมวดหมู่แล้ว");
            };

            const handleCoverImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => handleMetaChange(activeTab, 'coverImage', reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleRemoveCoverImage = (e) => {
                e.stopPropagation();
                handleMetaChange(activeTab, 'coverImage', null);
            };

            const saveEditName = () => {
                if (editingTab !== null) {
                    const newName = editNameValue.trim() || `Option ${editingTab}`;
                    handleMetaChange(editingTab, 'name', newName);
                    setEditingTab(null);
                }
            };

            const addScenario = () => {
                const newId = (Math.max(...scenarioIds) || 0) + 1;
                setScenarios(prev => ({ ...prev, [newId]: {} })); 
                setScenarioMeta(prev => ({ ...prev, [newId]: { duration: 6, name: `Option ${newId}`, markup: 0 } }));
                setActiveTab(newId);
                setToastMessage("เพิ่มทางเลือกใหม่แล้ว");
            };

            const deleteScenario = (id) => {
                if (scenarioIds.length <= 1) return alert("ต้องมีอย่างน้อย 1 ทางเลือก");
                if (confirm(`ยืนยันลบ "${scenarioMeta[id]?.name}"?`)) {
                    const newScenarios = { ...scenarios }; delete newScenarios[id];
                    const newMeta = { ...scenarioMeta }; delete newMeta[id];
                    setScenarios(newScenarios);
                    setScenarioMeta(newMeta);
                    if (activeTab === id) setActiveTab(Number(Object.keys(newScenarios)[0]) || 1);
                    setToastMessage("ลบเรียบร้อย");
                }
            };

            const generateTestData = () => {
                if (!confirm("สร้างข้อมูลตัวอย่าง?")) return;
                const testData = {};
                categories.forEach(cat => {
                    let price = 0;
                    if (cat.name.includes('ทีมงาน') || cat.id.includes('cat_01')) price = 250000;
                    else if (cat.name.includes('พัฒนา') || cat.id.includes('cat_02')) price = 150000;
                    else if (cat.name.includes('ตลาด') || cat.id.includes('cat_03')) price = 50000;
                    else price = Math.floor(Math.random() * 30000) + 5000;
                    testData[cat.id] = [{ id: Date.now() + Math.random(), name: cat.name, total: price }];
                });
                setScenarios(prev => ({ ...prev, [activeTab]: testData }));
                setScenarioMeta(prev => ({ ...prev, [activeTab]: { ...prev[activeTab], duration: 6, markup: 7 } }));
                setToastMessage("สร้างข้อมูลตัวอย่างแล้ว");
            };

            const saveBulkItems = () => {
                setScenarios(prev => {
                    const updatedScenario = { ...prev[activeTab] };
                    bulkItems.forEach(item => {
                        const val = parseFloat(item.total) || 0;
                        const catInfo = categories.find(c => c.id === item.categoryId);
                        if(catInfo) updatedScenario[item.categoryId] = [{ id: Date.now(), name: catInfo.name, total: val }];
                    });
                    return { ...prev, [activeTab]: updatedScenario };
                });
                setToastMessage("บันทึกข้อมูลงบประมาณแล้ว");
            };

            const getCategoryTotal = (scenId, catId) => scenarios[scenId]?.[catId]?.reduce((s, i) => s + i.total, 0) || 0;
            const getDirectTotal = (scenId) => categories.reduce((s, c) => s + getCategoryTotal(scenId, c.id), 0);
            const getGrandTotal = (scenId) => {
                const direct = getDirectTotal(scenId);
                const markup = scenarioMeta[scenId]?.markup || 0;
                // Risk factor only affects current tab calculation if in compare mode it doesn't matter much as risk is visual
                // But let's add risk to grand total for the current active tab visualization
                const risk = activeTab !== 'compare' && activeTab === scenId ? riskFactor : 0;
                return direct * (1 + (markup + risk) / 100);
            };

            const currentDirectTotal = useMemo(() => activeTab === 'compare' ? 0 : getDirectTotal(activeTab), [scenarios, activeTab, categories]);
            const currentMarkup = useMemo(() => activeTab === 'compare' ? 0 : (scenarioMeta[activeTab]?.markup || 0), [scenarioMeta, activeTab]);
            const currentGrandTotal = currentDirectTotal * (1 + (currentMarkup + riskFactor) / 100);
            const liveBulkTotal = useMemo(() => bulkItems.reduce((s, i) => s + (parseFloat(i.total) || 0), 0), [bulkItems]);

            const chartData = useMemo(() => {
                if (activeTab === 'compare') return [];
                return categories.map(cat => ({ name: cat.name.split('. ')[1] || cat.name, value: getCategoryTotal(activeTab, cat.id) })).filter(d => d.value > 0);
            }, [scenarios, activeTab, categories]);

            const handleDownloadPDF = async () => {
                setIsExporting(true);
                document.body.classList.add('generating-pdf');
                await new Promise(r => setTimeout(r, 500));
                const element = document.getElementById('root');
                const opt = { margin: 5, filename: `${projectName}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } };
                html2pdf().set(opt).from(element).save().then(() => { document.body.classList.remove('generating-pdf'); setIsExporting(false); setToastMessage("ดาวน์โหลด PDF แล้ว"); });
            };
            
            const copyToOtherModule = () => {
                const targetId = scenarioIds.find(id => id !== activeTab);
                if (!targetId) return alert("ต้องมี Module อื่นเพื่อคัดลอกไป");
                if (!confirm(`ต้องการคัดลอกไปยัง "${scenarioMeta[targetId].name}"?`)) return;
                setScenarios(prev => ({ ...prev, [targetId]: JSON.parse(JSON.stringify(scenarios[activeTab])) }));
                setScenarioMeta(prev => ({ ...prev, [targetId]: { ...prev[targetId], area: prev[activeTab].area, coverImage: prev[activeTab].coverImage, markup: prev[activeTab].markup } }));
                setToastMessage(`คัดลอกข้อมูลแล้ว`);
            };

            const clearAll = () => {
                if(confirm('ล้างข้อมูลใหม่ทั้งหมด?')) {
                    setScenarios({1:{},2:{}});
                    setScenarioMeta({ 1: { duration: 6, name: 'Option 1: ทำเอง', markup: 0 }, 2: { duration: 4, name: 'Option 2: จ้างทำ', markup: 0 } });
                    setActiveTab(1);
                    setToastMessage("เริ่มโครงการใหม่แล้ว");
                }
            };
            
            const exportData = () => {
                const data = { version: "V9.1", projectName, scenarios, scenarioMeta, categories };
                const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `Project_${projectName}_Backup.json`; a.click();
            };
             const importData = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.scenarios) {
                            setProjectName(data.projectName || "Project"); setScenarios(data.scenarios); setScenarioMeta(data.scenarioMeta); if(data.categories) setCategories(data.categories);
                            setActiveTab(Number(Object.keys(data.scenarios)[0]) || 1); setToastMessage("นำเข้าข้อมูลสำเร็จ");
                        }
                    } catch (err) { alert("ไฟล์ไม่ถูกต้อง"); }
                };
                reader.readAsText(file); e.target.value = '';
            };
            
            const KPICards = ({ total, duration, items }) => {
                const getSum = (ids) => items.filter(i => ids.includes(i.categoryId)).reduce((sum, i) => sum + (parseFloat(i.total) || 0), 0);
                const peopleCost = getSum(['cat_01', 'cat_06']);
                const opsToolsCost = getSum(['cat_02', 'cat_04', 'cat_05']);
                const overheadCost = getSum(['cat_07', 'cat_08', 'cat_09', 'cat_10']);
                const burnRate = duration > 0 ? total / duration : 0;
                const overheadRatio = total > 0 ? (overheadCost / total) * 100 : 0;
                const ovhColor = overheadRatio > 25 ? 'text-red-500' : overheadRatio > 15 ? 'text-amber-500' : 'text-emerald-600';
                const ovhBg = overheadRatio > 25 ? 'bg-red-50' : overheadRatio > 15 ? 'bg-amber-50' : 'bg-emerald-50';

                return (
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6 hide-print">
                        <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col hover:shadow-md transition">
                            <div className="flex items-center gap-2 text-gray-400 mb-2"><div className="p-1.5 rounded-lg bg-orange-50 text-orange-500"><i className="ph-bold ph-fire"></i></div><span className="text-xs font-bold uppercase tracking-wide">Burn Rate</span></div>
                            <div className="text-2xl font-bold text-gray-800 tracking-tight">{formatNumber(burnRate)}</div><div className="text-[10px] text-gray-400 mt-1">บาท / เดือน (Avg.)</div>
                        </div>
                        <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col hover:shadow-md transition">
                            <div className="flex items-center gap-2 text-gray-400 mb-2"><div className="p-1.5 rounded-lg bg-blue-50 text-blue-500"><i className="ph-bold ph-users-three"></i></div><span className="text-xs font-bold uppercase tracking-wide">People Cost</span></div>
                            <div className="text-2xl font-bold text-blue-600 tracking-tight">{formatNumber(peopleCost)}</div><div className="text-[10px] text-gray-400 mt-1">ทีมงาน & Outsource</div>
                        </div>
                        <div className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col hover:shadow-md transition">
                            <div className="flex items-center gap-2 text-gray-400 mb-2"><div className="p-1.5 rounded-lg bg-indigo-50 text-indigo-500"><i className="ph-bold ph-gear"></i></div><span className="text-xs font-bold uppercase tracking-wide">Ops & Tools</span></div>
                            <div className="text-2xl font-bold text-indigo-600 tracking-tight">{formatNumber(opsToolsCost)}</div><div className="text-[10px] text-gray-400 mt-1">ผลิต & เครื่องมือ</div>
                        </div>
                        <div className={`bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col hover:shadow-md transition relative overflow-hidden`}>
                            <div className={`absolute top-0 right-0 w-16 h-16 ${ovhBg} rounded-full -mr-8 -mt-8 opacity-50`}></div>
                            <div className="flex items-center gap-2 text-gray-400 mb-2 relative z-10"><div className={`p-1.5 rounded-lg ${ovhBg} ${ovhColor.replace('text', 'bg').replace('500', '100').replace('600', '100')}`}><i className="ph-bold ph-chart-pie-slice"></i></div><span className="text-xs font-bold uppercase tracking-wide">Overhead %</span></div>
                            <div className={`text-2xl font-bold ${ovhColor} tracking-tight relative z-10`}>{overheadRatio.toFixed(1)}%</div><div className="text-[10px] text-gray-400 mt-1 relative z-10">บริหารจัดการ & สำรอง</div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen pb-40 bg-gray-50 text-gray-800 font-sans">
                    {toastMessage && <Toast message={toastMessage} onClose={() => setToastMessage(null)} />}

                    {/* Header */}
                    <header className="bg-white shadow-sm sticky top-0 z-20 print:static print:shadow-none border-b border-gray-200">
                        <div className="max-w-6xl mx-auto px-4 py-3">
                            <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-3">
                                <div className="flex items-center gap-3 w-full md:w-auto">
                                    <div className="bg-emerald-600 text-white p-2.5 rounded-xl shadow-lg shadow-emerald-200"><i className="ph-duotone ph-briefcase text-2xl"></i></div>
                                    <div>
                                        {isEditingTitle ? <input autoFocus type="text" value={projectName} onChange={(e) => setProjectName(e.target.value)} onBlur={() => setIsEditingTitle(false)} className="text-xl font-extrabold text-gray-900 border-b-2 border-emerald-500 outline-none bg-transparent" /> : <h1 onClick={() => setIsEditingTitle(true)} className="text-xl font-extrabold text-gray-900 leading-none tracking-tight cursor-pointer hover:text-emerald-600 transition flex items-center gap-2" title="คลิกเพื่อเปลี่ยนชื่อโครงการ">{projectName} <i className="ph-bold ph-pencil-simple text-xs text-gray-400"></i></h1>}
                                        <p className="text-xs text-gray-500 font-medium mt-0.5">Project Cost Comparator Pro V9 (Cover Image)</p>
                                    </div>
                                </div>
                                <div className="flex gap-2 hide-print w-full md:w-auto overflow-x-auto pb-1 no-scrollbar">
                                    <button onClick={exportData} className="p-2.5 bg-white text-gray-600 border border-gray-200 rounded-lg hover:bg-gray-50 transition shadow-sm" title="Backup"><i className="ph-bold ph-download-simple text-lg"></i></button>
                                    <label className="p-2.5 bg-white text-gray-600 border border-gray-200 rounded-lg hover:bg-gray-50 transition shadow-sm cursor-pointer" title="Restore"><i className="ph-bold ph-upload-simple text-lg"></i><input type="file" onChange={importData} className="hidden" accept=".json" /></label>
                                    <div className="w-px h-8 bg-gray-200 mx-1"></div>
                                    {activeTab !== 'compare' && (
                                        <>
                                            <button onClick={generateTestData} className="px-3 py-2 bg-amber-50 text-amber-700 rounded-lg hover:bg-amber-100 border border-amber-200 font-bold text-sm flex items-center gap-2"><i className="ph-fill ph-magic-wand text-lg"></i> Auto Fill</button>
                                            <button onClick={copyToOtherModule} className="p-2.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition shadow-sm border border-blue-100" title="Copy"><i className="ph-bold ph-copy text-lg"></i></button>
                                        </>
                                    )}
                                    <button onClick={clearAll} className="p-2.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg"><i className="ph ph-trash text-lg"></i></button>
                                    <button onClick={handleDownloadPDF} disabled={isExporting} className="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-800 transition shadow-md whitespace-nowrap">{isExporting ? <i className="ph ph-spinner animate-spin"></i> : <i className="ph ph-file-pdf"></i>} <span>PDF</span></button>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-2 hide-print overflow-x-auto pb-1 no-scrollbar">
                                <div ref={scrollRef} className="flex gap-1 bg-gray-100 p-1.5 rounded-xl border border-gray-200">
                                    {scenarioIds.map(id => (
                                        <div key={id} className="relative group shrink-0">
                                            {editingTab === id ? (
                                                <input autoFocus type="text" value={editNameValue} onChange={(e) => setEditNameValue(e.target.value)} onBlur={saveEditName} onKeyDown={(e) => e.key === 'Enter' && saveEditName()} className="w-32 px-3 py-1.5 text-sm border-2 border-emerald-500 rounded-lg outline-none shadow-sm" />
                                            ) : (
                                                <button onClick={() => setActiveTab(id)} onDoubleClick={() => { setEditingTab(id); setEditNameValue(scenarioMeta[id]?.name); }} className={`px-4 py-1.5 text-sm font-bold rounded-lg transition flex items-center gap-2 border ${activeTab === id ? 'bg-white text-emerald-600 border-gray-200 shadow-sm' : 'text-gray-500 border-transparent hover:bg-gray-200/50'}`}>
                                                    <span className={`w-2 h-2 rounded-full ${activeTab === id ? 'bg-emerald-500' : 'bg-gray-300'}`}></span>
                                                    {scenarioMeta[id]?.name}
                                                </button>
                                            )}
                                            {scenarioIds.length > 1 && !editingTab && <button onClick={(e) => {e.stopPropagation(); deleteScenario(id)}} className="absolute -top-1.5 -right-1.5 w-5 h-5 bg-gray-400 text-white rounded-full flex items-center justify-center text-[10px] shadow-sm transition-all z-10 hover:bg-red-500 hover:scale-110 bg-gray-200" title="ลบ Module นี้"><i className="ph-bold ph-x"></i></button>}
                                        </div>
                                    ))}
                                    <button onClick={addScenario} className="px-3 bg-white text-gray-400 hover:text-green-600 rounded-lg border border-transparent hover:border-green-200 transition"><i className="ph-bold ph-plus"></i></button>
                                </div>
                                <button onClick={() => setActiveTab('compare')} className={`px-5 py-2 text-sm font-bold rounded-xl flex items-center gap-2 ml-auto transition shadow-sm ${activeTab === 'compare' ? 'bg-purple-600 text-white shadow-purple-200' : 'bg-white text-purple-700 hover:bg-purple-50 border border-purple-100'}`}><i className="ph ph-chart-bar"></i> เปรียบเทียบ</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-6 space-y-6">
                        {activeTab !== 'compare' ? (
                            <>
                                {/* Dashboard Summary */}
                                <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                                    <div className="md:col-span-8 bg-white p-6 rounded-2xl shadow-sm border border-gray-200 flex flex-col md:flex-row items-center gap-6 hide-print relative overflow-hidden">
                                        <div className="absolute top-0 right-0 w-48 h-48 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-full -mr-16 -mt-16 opacity-70 pointer-events-none"></div>
                                        
                                        <div className="flex gap-6 w-full z-10">
                                            {/* Enhanced Cover Image */}
                                            <div className="relative group shrink-0">
                                                <div 
                                                    onClick={() => coverInputRef.current?.click()} 
                                                    className={`w-28 h-28 rounded-2xl border-2 border-dashed flex flex-col items-center justify-center cursor-pointer transition-all relative overflow-hidden bg-white shadow-sm ${scenarioMeta[activeTab]?.coverImage ? 'border-emerald-300' : 'border-gray-300 hover:border-emerald-400 hover:bg-emerald-50'}`}
                                                    style={{
                                                        backgroundImage: scenarioMeta[activeTab]?.coverImage ? `url(${scenarioMeta[activeTab].coverImage})` : 'none', 
                                                        backgroundSize: 'cover', 
                                                        backgroundPosition: 'center'
                                                    }}
                                                >
                                                    {!scenarioMeta[activeTab]?.coverImage && (
                                                        <>
                                                            <i className="ph-duotone ph-image text-3xl text-gray-300 mb-1 group-hover:text-emerald-500 transition"></i>
                                                            <span className="text-xs text-gray-400 font-medium group-hover:text-emerald-600">เพิ่มรูปปก</span>
                                                        </>
                                                    )}
                                                    
                                                    {/* Hover Overlay for Edit */}
                                                    <div className={`absolute inset-0 bg-black/40 flex items-center justify-center transition-opacity duration-200 ${scenarioMeta[activeTab]?.coverImage ? 'opacity-0 group-hover:opacity-100' : 'hidden'}`}>
                                                        <i className="ph-bold ph-pencil-simple text-white text-xl"></i>
                                                    </div>
                                                </div>

                                                {/* Remove Button (Only if image exists) */}
                                                {scenarioMeta[activeTab]?.coverImage && (
                                                    <button 
                                                        onClick={handleRemoveCoverImage}
                                                        className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center shadow-md hover:bg-red-600 transition z-20 scale-90 hover:scale-100"
                                                        title="ลบรูปปก"
                                                    >
                                                        <i className="ph-bold ph-x text-xs"></i>
                                                    </button>
                                                )}
                                                
                                                <input type="file" ref={coverInputRef} className="hidden" accept="image/*" onChange={handleCoverImageUpload} />
                                            </div>

                                            <div className="flex-1">
                                                <h2 className="text-2xl font-bold text-gray-800 mb-2">{scenarioMeta[activeTab]?.name}</h2>
                                                <div className="flex flex-wrap items-center gap-3 text-sm">
                                                    <div className="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200">
                                                        <i className="ph-duotone ph-clock text-blue-500"></i>
                                                        <span className="text-gray-500 font-medium">ระยะเวลา:</span>
                                                        <input type="number" value={scenarioMeta[activeTab]?.duration || 0} onChange={(e) => handleMetaChange(activeTab, 'duration', e.target.value)} className="w-12 bg-transparent text-right font-bold text-gray-800 outline-none" />
                                                        <span className="text-gray-500">เดือน</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200">
                                                        <i className="ph-duotone ph-trend-up text-green-500"></i>
                                                        <span className="text-gray-500 font-medium">Buffer/Vat:</span>
                                                        <input type="number" value={scenarioMeta[activeTab]?.markup || 0} onChange={(e) => handleMetaChange(activeTab, 'markup', e.target.value)} className="w-12 bg-transparent text-right font-bold text-green-600 outline-none" />
                                                        <span className="text-gray-500">%</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 bg-orange-50 px-3 py-1.5 rounded-lg border border-orange-200">
                                                         <i className="ph-duotone ph-warning text-orange-500"></i>
                                                         <span className="text-orange-700 font-medium text-xs">Risk: +{riskFactor}%</span>
                                                         <input type="range" min="0" max="30" step="1" value={riskFactor} onChange={(e) => setRiskFactor(Number(e.target.value))} className="range-slider accent-orange-500 w-20 h-1 bg-orange-200 rounded-lg appearance-none cursor-pointer" />
                                                    </div>
                                                </div>
                                                <div className="mt-4 flex items-center gap-2 text-xs text-gray-400">
                                                    {currentGrandTotal > 0 && <span>เฉลี่ย: {formatMoney(currentGrandTotal / (scenarioMeta[activeTab]?.duration || 1))} / เดือน</span>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="md:col-span-4 bg-white p-4 rounded-2xl shadow-sm border border-gray-200 flex items-center justify-center hide-print relative min-h-[160px]">
                                            <DonutChart data={chartData} total={currentDirectTotal} />
                                            {currentDirectTotal === 0 && <div className="text-center text-gray-400 text-xs absolute">ใส่ข้อมูลเพื่อแสดงกราฟ</div>}
                                    </div>
                                </div>

                                {/* KPIs inserted here */}
                                <KPICards total={currentGrandTotal} duration={scenarioMeta[activeTab]?.duration} items={bulkItems} />

                                {/* Main Input Table */}
                                <section className="hide-print bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden ring-1 ring-black/5 relative">
                                    <div className="p-5 bg-gradient-to-r from-gray-900 to-gray-800 text-white flex justify-between items-center">
                                        <div><h3 className="font-bold text-lg flex items-center gap-2"><i className="ph-fill ph-list-numbers text-emerald-400"></i> กรอกงบประมาณ (Budget Input)</h3><p className="text-gray-400 text-xs mt-0.5">ระบุยอดเงินรวมในแต่ละหมวด</p></div>
                                        <div className="text-right"><div className="text-[10px] text-gray-400 uppercase tracking-wider font-semibold">Live Preview</div><div className="text-2xl font-bold text-emerald-300 font-mono">{formatMoney(liveBulkTotal)}</div></div>
                                    </div>
                                    <div className="p-0 overflow-visible">
                                        <table className="w-full text-sm min-w-[600px]">
                                            <thead>
                                                <tr className="bg-gray-50 text-gray-500 border-b border-gray-200 text-xs uppercase tracking-wider">
                                                    <th className="py-3 px-4 text-left font-semibold w-2/3 flex items-center gap-2">
                                                        หมวดหมู่ (แก้ไขชื่อได้)
                                                        <button 
                                                            onClick={handleAddCategory} 
                                                            className="w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center hover:bg-emerald-200 transition shadow-sm"
                                                            title="เพิ่มหมวดหมู่ใหม่"
                                                        >
                                                            <i className="ph-bold ph-plus"></i>
                                                        </button>
                                                    </th>
                                                    <th className="py-3 px-4 text-right font-semibold w-1/3">จำนวนเงิน (บาท)</th>
                                                    <th className="w-12"></th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {bulkItems.map((item, idx) => {
                                                    const catInfo = categories.find(c => c.id === item.categoryId);
                                                    return (
                                                        <tr key={idx} className="hover:bg-emerald-50/30 transition group relative">
                                                            <td className="py-3 px-4 font-medium text-gray-700">
                                                                <div className="flex items-center gap-3">
                                                                    <button 
                                                                        onClick={() => handleDeleteCategory(item.categoryId)} 
                                                                        className="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 transition shadow-sm opacity-80 hover:opacity-100"
                                                                        title="ลบหมวดหมู่นี้"
                                                                    >
                                                                        <i className="ph-bold ph-minus"></i>
                                                                    </button>
                                                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${catInfo?.color.split(' ')[0].replace('text', 'bg').replace('100', '200') || 'bg-gray-200'} text-gray-600`}><i className={`${catInfo?.icon || 'ph-hash'} ph-duotone text-lg`}></i></div>
                                                                    <input type="text" value={catInfo ? catInfo.name : ''} onChange={(e) => handleCategoryNameChange(item.categoryId, e.target.value)} className="w-full bg-transparent border-b border-transparent focus:border-emerald-500 outline-none font-bold text-gray-700 transition" />
                                                                </div>
                                                            </td>
                                                            <td className="py-2 px-4"><input type="number" value={item.total} onChange={(e) => handleBulkChange(idx, e.target.value)} className="w-full p-2.5 border border-gray-200 rounded-lg text-right focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition bg-white font-mono text-lg font-bold text-gray-800 placeholder-gray-300" placeholder="0.00" /></td>
                                                            <td className="text-center pr-2">{(parseFloat(item.total) > 0) && <button onClick={() => resetRow(idx)} className="text-gray-300 hover:text-red-500 p-1.5 rounded-md hover:bg-red-50 transition" title="ล้างค่า"><i className="ph-bold ph-minus"></i></button>}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="px-5 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
                                        <button onClick={saveBulkItems} className="bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 hover:shadow-xl hover:-translate-y-0.5 transition flex items-center gap-2"><i className="ph-bold ph-floppy-disk text-lg"></i> บันทึกงบประมาณ</button>
                                    </div>
                                </section>

                                <div className="bg-white rounded-xl border border-gray-200 p-4 shadow-sm hide-print mt-6">
                                    <div className="text-sm font-bold text-gray-700 mb-2">หมายเหตุ / สมมติฐาน (Assumptions)</div>
                                    <textarea className="w-full p-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none h-24 resize-none bg-gray-50" placeholder="ใส่รายละเอียด เช่น ไม่รวมค่าการตลาด, ต้องจ่ายงวดแรก 30%..." value={scenarioMeta[activeTab]?.remarks || ''} onChange={(e) => handleMetaChange(activeTab, 'remarks', e.target.value)}></textarea>
                                </div>
                            </>
                        ) : (
                            <div className="bg-white rounded-2xl shadow-lg border border-purple-100 overflow-hidden ring-1 ring-black/5">
                                <div className="p-6 border-b border-purple-100 bg-gradient-to-r from-purple-50 via-white to-white">
                                    <h2 className="text-xl font-bold text-purple-900 flex items-center gap-2"><i className="ph-duotone ph-scales text-2xl"></i> เปรียบเทียบทางเลือก (Option Comparison)</h2>
                                    <p className="text-sm text-purple-400 ml-8">วิเคราะห์ความคุ้มค่าของการลงทุน (ROI Analysis)</p>
                                </div>
                                <div className="p-6 border-b border-gray-100 bg-gray-50/30">
                                    {scenarioIds.length >= 2 && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                            {/* Summary Cards */}
                                            {scenarioIds.slice(0, 2).map((id, idx) => {
                                                const total = getGrandTotal(id);
                                                const duration = scenarioMeta[id]?.duration || 1;
                                                const hasImage = !!scenarioMeta[id]?.coverImage;
                                                
                                                return (
                                                    <div key={id} className="bg-white rounded-xl border border-gray-200 shadow-sm relative overflow-hidden hover:shadow-md transition group">
                                                        {hasImage ? (
                                                            <div className="h-40 w-full bg-gray-100 relative overflow-hidden group-hover:opacity-90 transition">
                                                                <div 
                                                                    className="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105"
                                                                    style={{ backgroundImage: `url(${scenarioMeta[id].coverImage})` }}
                                                                ></div>
                                                                <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                                                                <div className="absolute bottom-3 left-4 right-4 text-white">
                                                                    <div className="text-xs font-medium opacity-80 mb-0.5">Option {idx + 1}</div>
                                                                    <h3 className="font-bold text-lg truncate shadow-black drop-shadow-md">{scenarioMeta[id]?.name}</h3>
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div className={`h-2 bg-gradient-to-r ${idx === 0 ? 'from-blue-500 to-blue-400' : 'from-emerald-500 to-emerald-400'}`}></div>
                                                        )}

                                                        <div className="p-5">
                                                            {!hasImage && <h3 className="font-bold text-gray-800 text-lg mb-3 flex items-center gap-2">
                                                                <span className={`w-3 h-3 rounded-full ${idx === 0 ? 'bg-blue-500' : 'bg-emerald-500'}`}></span>
                                                                {scenarioMeta[id]?.name}
                                                            </h3>}
                                                            
                                                            <div className="flex justify-between items-end mb-2">
                                                                <div>
                                                                    <div className="text-sm text-gray-500 mb-1">งบประมาณรวม (Total)</div>
                                                                    <div className="text-3xl font-extrabold text-gray-900 font-mono tracking-tight">{formatMoney(total)}</div>
                                                                </div>
                                                                <div className="text-right">
                                                                     <div className={`text-xs px-2 py-1 rounded-lg font-bold ${idx === 0 ? 'bg-blue-50 text-blue-600' : 'bg-emerald-50 text-emerald-600'}`}>
                                                                        {idx === 0 ? 'Base' : 'Compare'}
                                                                     </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="pt-4 mt-4 border-t border-gray-100 flex justify-between items-center text-sm">
                                                                <span className="text-gray-500">ระยะเวลา: <strong className="text-gray-700">{duration} เดือน</strong></span>
                                                                <span className="text-gray-500">เฉลี่ย: <strong className="text-gray-700">{formatMoney(total/duration)}/ด.</strong></span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    )}
                                    <div className="h-[400px]"><ComparisonBarChart scenarios={scenarios} scenarioIds={scenarioIds} scenarioMeta={scenarioMeta} categories={categories} /></div>
                                </div>
                            </div>
                        )}
                    </main>

                    {(activeTab !== 'compare') && (
                        <div className="fixed-footer fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-gray-200 p-4 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)] flex justify-between items-center max-w-6xl mx-auto md:rounded-t-2xl print:shadow-none z-30 transition-all">
                            <div className="flex flex-col"><span className="text-[10px] text-gray-400 uppercase font-bold tracking-widest">งบประมาณรวม (Total Budget)</span><div className="flex items-center gap-2"><span className="text-gray-700 font-semibold text-sm truncate max-w-[150px]">{scenarioMeta[activeTab]?.name}</span>{(scenarioMeta[activeTab]?.markup || 0) > 0 && <span className="text-[10px] bg-green-100 text-green-700 px-1.5 rounded">+{scenarioMeta[activeTab]?.markup}%</span>}{riskFactor > 0 && <span className="text-[10px] bg-orange-100 text-orange-700 px-1.5 rounded">+Risk {riskFactor}%</span>}</div></div>
                            <div className="flex flex-col items-end"><span className="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-teal-500 font-mono">{formatMoney(currentGrandTotal)}</span><span className="text-xs text-gray-400 font-medium">{ThaiBahtText(currentGrandTotal)}</span></div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
